<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>加班时长计算器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .result-item {
            margin: 10px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .warning {
            color: #ff4444;
        }

        .success {
            color: #4CAF50;
        }

        .input-methods {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-method {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .input-method.active {
            border-color: #4CAF50;
            background-color: #f0f9f0;
        }

        textarea {
            width: 100%;
            height: 200px;
            margin-top: 10px;
            padding: 8px;
            box-sizing: border-box;
        }

        .batch-result {
            margin-top: 20px;
        }

        .batch-result table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .batch-result th,
        .batch-result td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .batch-result th {
            background-color: #f5f5f5;
        }

        .batch-result tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>

<body>
    <h2>加班时长计算器</h2>

    <div class="input-methods">
        <div class="input-method active" id="singleInput">
            <h3>单条数据输入</h3>
            <form id="shiftForm">
                <label for="workDay">工作日（周几）：</label>
                <select id="workDay" required>
                    <option value="周一">周一</option>
                    <option value="周二">周二</option>
                    <option value="周三">周三</option>
                    <option value="周四">周四</option>
                    <option value="周五">周五</option>
                    <option value="周六">周六</option>
                    <option value="周日">周日</option>
                </select>

                <label for="startTime">上班打卡时间：</label>
                <input type="time" id="startTime" required>

                <label for="endTime">下班打卡时间：</label>
                <input type="time" id="endTime" required>

                <label for="previousEndTime">前一天下班时间（可选）：</label>
                <input type="time" id="previousEndTime">

                <button type="submit">计算考勤情况</button>
            </form>
        </div>

        <div class="input-method" id="batchInput">
            <h3>批量数据输入</h3>
            <p>请按以下格式输入数据（每行一条记录）：</p>
            <p>日期,工作日,上班时间,下班时间,前一天下班时间(可选)</p>
            <p>示例：</p>
            <p>2024/03/18,周一,09:00,18:00,17:45</p>
            <p>2024/03/19,周二,09:30,19:30</p>
            <textarea id="batchData" placeholder="2024/03/18,周一,09:00,18:00,17:45&#10;2024/03/19,周二,09:30,19:30"></textarea>
            <button onclick="calculateBatch()">批量计算</button>
        </div>
    </div>

    <div class="result" id="result"></div>
    <div class="batch-result" id="batchResult"></div>

    <script>
        // 格式化时间函数
        function formatTime(timeStr) {
            if (!timeStr) return '';
            // 如果时间格式是 "9:16" 这样的格式，转换为 "09:16"
            const parts = timeStr.split(':');
            if (parts.length === 2) {
                const hours = parts[0].padStart(2, '0');
                const minutes = parts[1].padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            return timeStr;
        }

        // 单条数据计算函数
        function calculateSingle(workDay, startTime, endTime, previousEndTime) {
            if (!startTime || !endTime) {
                return {
                    workDay,
                    isLate: false,
                    lateTime: 0,
                    netWorkDuration: 0,
                    overtimeHours: 0,
                    isWeekend: workDay === "周六" || workDay === "周日"
                };
            }

            const start = new Date(`1970-01-01T${formatTime(startTime)}`);
            const end = new Date(`1970-01-01T${formatTime(endTime)}`);
            const prevEnd = previousEndTime ? new Date(`1970-01-01T${formatTime(previousEndTime)}`) : null;

            const isWeekend = workDay === "周六" || workDay === "周日";
            const normalWorkStart = new Date(`1970-01-01T09:00`);
            const normalWorkEnd = new Date(`1970-01-01T17:45`);
            const lunchStart = new Date(`1970-01-01T12:00`);
            const lunchEnd = new Date(`1970-01-01T13:30`);
            const overtimeStart = new Date(`1970-01-01T19:00`);

            let lateTime = 0;
            let isLate = false;
            let lateThreshold = new Date(`1970-01-01T09:10`);
            
            if (prevEnd && prevEnd >= new Date(`1970-01-01T21:00`)) {
                lateThreshold = new Date(`1970-01-01T09:40`);
            }

            if (start > lateThreshold) {
                isLate = true;
                lateTime = (start - normalWorkStart) / (1000 * 60);
            }

            const workDuration = (end - start) / (1000 * 60 * 60);
            const lunchDuration = 1.5;
            let netWorkDuration = workDuration - lunchDuration;

            let overtimeHours = 0;
            if (!isWeekend) {
                // 计算实际加班开始时间（考虑迟到时间）
                const actualOvertimeStart = new Date(overtimeStart.getTime() + (isLate ? lateTime * 60 * 1000 : 0));
                
                if (end > actualOvertimeStart) {
                    overtimeHours = (end - actualOvertimeStart) / (1000 * 60 * 60);
                }
                // 如果没有加班，则默认出勤时长为8小时
                if (overtimeHours === 0) {
                    netWorkDuration = 8;
                }
            } else {
                overtimeHours = netWorkDuration;
            }

            return {
                workDay,
                isLate,
                lateTime,
                netWorkDuration,
                overtimeHours,
                isWeekend
            };
        }

        // 单条数据表单提交处理
        document.getElementById('shiftForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const workDay = document.getElementById('workDay').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const previousEndTime = document.getElementById('previousEndTime').value;

            const result = calculateSingle(workDay, startTime, endTime, previousEndTime);
            
            let resultHTML = '<div class="result-item">';
            
            if (result.isWeekend) {
                resultHTML += `<p class="success">周末出勤时间：${result.netWorkDuration.toFixed(2)}小时</p>`;
                resultHTML += `<p class="success">可调休时间：${result.netWorkDuration.toFixed(2)}小时</p>`;
            } else {
                if (result.isLate) {
                    resultHTML += `<p class="warning">迟到时间：${result.lateTime}分钟</p>`;
                }

                if (result.netWorkDuration < 8) {
                    resultHTML += `<p class="warning">出勤时间不足：${(8 - result.netWorkDuration).toFixed(2)}小时</p>`;
                } else {
                    resultHTML += `<p class="success">出勤时间：${result.netWorkDuration.toFixed(2)}小时</p>`;
                }

                if (result.overtimeHours > 0) {
                    resultHTML += `<p class="success">加班时间：${result.overtimeHours.toFixed(2)}小时</p>`;
                    resultHTML += `<p class="success">可调休时间：${result.overtimeHours.toFixed(2)}小时</p>`;
                }
            }

            resultHTML += '</div>';
            document.getElementById('result').innerHTML = resultHTML;
        });

        // 批量计算函数
        function calculateBatch() {
            const batchData = document.getElementById('batchData').value;
            const lines = batchData.split('\n').filter(line => line.trim());
            
            // 计算统计数据
            let totalWorkDays = 0;
            let totalLateDays = 0;
            let totalLateMinutes = 0;
            let totalOvertimeHours = 0;
            let totalWorkHours = 0;
            let totalWeekendDays = 0;
            let totalWeekendHours = 0;

            lines.forEach(line => {
                const [date, workDay, startTime, endTime, previousEndTime] = line.split(',').map(item => item.trim());
                const result = calculateSingle(workDay, startTime, endTime, previousEndTime);

                if (startTime && endTime) {  // 只统计有打卡记录的天数
                    if (result.isWeekend) {
                        totalWeekendDays++;
                        totalWeekendHours += result.netWorkDuration;
                    } else {
                        totalWorkDays++;
                        if (result.isLate) {
                            totalLateDays++;
                            totalLateMinutes += result.lateTime;
                        }
                        totalOvertimeHours += result.overtimeHours;
                        totalWorkHours += result.netWorkDuration;
                    }
                }
            });

            // 生成总结HTML
            let summaryHTML = `
                <div class="result-item">
                    <h3>考勤统计</h3>
                    <p>工作日出勤：${totalWorkDays}天</p>
                    <p>迟到天数：${totalLateDays}天</p>
                    <p>总迟到时间：${totalLateMinutes.toFixed(0)}分钟</p>
                    <p>总加班时长：${totalOvertimeHours.toFixed(2)}小时</p>
                    <p>总工作时长：${totalWorkHours.toFixed(2)}小时</p>
                    <p>周末出勤：${totalWeekendDays}天</p>
                    <p>周末工作时长：${totalWeekendHours.toFixed(2)}小时</p>
                    <p>可调休总时长：${(totalOvertimeHours + totalWeekendHours).toFixed(2)}小时</p>
                </div>
            `;

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>工作日</th>
                            <th>上班时间</th>
                            <th>下班时间</th>
                            <th>迟到时间</th>
                            <th>出勤时间</th>
                            <th>加班时间</th>
                            <th>可调休时间</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            lines.forEach(line => {
                const [date, workDay, startTime, endTime, previousEndTime] = line.split(',').map(item => item.trim());
                const result = calculateSingle(workDay, startTime, endTime, previousEndTime);

                tableHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${workDay}</td>
                        <td>${startTime || '-'}</td>
                        <td>${endTime || '-'}</td>
                        <td>${result.isLate ? result.lateTime.toFixed(0) + '分钟' : '-'}</td>
                        <td>${result.netWorkDuration > 0 ? result.netWorkDuration.toFixed(2) + '小时' : '-'}</td>
                        <td>${result.overtimeHours > 0 ? result.overtimeHours.toFixed(2) + '小时' : '-'}</td>
                        <td>${result.overtimeHours > 0 ? result.overtimeHours.toFixed(2) + '小时' : '-'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            document.getElementById('batchResult').innerHTML = summaryHTML + tableHTML;
        }
    </script>
</body>

</html>